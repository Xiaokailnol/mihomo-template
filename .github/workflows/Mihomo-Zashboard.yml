name: Mihomo Zashboard

on:
  workflow_call:
    inputs:
      VERSION:
        required: true
        type: string
      ZASHBOARD_URL:
        required: true
        type: string
      ZASHBOARD_BRANCH:
        required: true
        type: string
      BUILD_DIR:
        required: true
        type: string
    secrets:
      PAT_TOKEN:
        required: true
        
env:
  VERSION: ${{inputs.VERSION}}
  ZASHBOARD_URL: ${{inputs.ZASHBOARD_URL}}
  ZASHBOARD_BRANCH: ${{inputs.ZASHBOARD_BRANCH}}
  BUILD_DIR: ${{inputs.BUILD_DIR}}
  
jobs:
  setup:
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false

    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Show system info
      uses: Xiaokailnol/actions@show-system

    - name: Free disk space
      uses: Xiaokailnol/actions@free-disk
      with:
        build-mount-path: /builder

    - name: Build System Setup
      uses: Xiaokailnol/actions@mihomo-build-setup

    - name: Clone Source Code
      working-directory: /builder
      id: clone
      run: |
        git clone $ZASHBOARD_URL -b $ZASHBOARD_BRANCH zashboard

    - name: Compile Zashboard
      id: zashboard
      working-directory: /builder    
      run: |
        cd zashboard
        pnpm i
        pnpm run build
        zip -r zashboard-dist.zip dist

    - name: Deploy to gh-pages-zashboard ðŸš€
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.PAT_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages-zashboard
          
    - name: Upload zashboard artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mihomo_metacubexd_${{ env.VERSION }}
        path: ${{ env.BUILD_DIR }}/zashboard/zashboard-dist.zip

    - name: Create zashboard release
      uses: ncipollo/release-action@v1
      with:
        name: v${{ env.VERSION }}
        tag: v${{ env.VERSION }}
        commit: master
        allowUpdates: true
        replacesArtifacts: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: |
          ${{ env.BUILD_DIR }}/zashboard/zashboard-dist.zip
